version: '3.8'\n\nservices:\n  # MQTT Broker\n  mosquitto:\n    image: eclipse-mosquitto:2.0\n    container_name: irrigation-mqtt-broker\n    ports:\n      - "1883:1883"\n      - "9001:9001"\n    volumes:\n      - ./mosquitto/config:/mosquitto/config\n      - ./mosquitto/data:/mosquitto/data\n      - ./mosquitto/log:/mosquitto/log\n    networks:\n      - irrigation-network\n    restart: unless-stopped\n\n  # PostgreSQL Database\n  postgres:\n    image: postgres:15-alpine\n    container_name: irrigation-db\n    environment:\n      POSTGRES_USER: ${POSTGRES_USER:-irrigation_user}\n      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-irrigation_pass}\n      POSTGRES_DB: ${POSTGRES_DB:-irrigation_db}\n    ports:\n      - "5432:5432"\n    volumes:\n      - postgres-data:/var/lib/postgresql/data\n    networks:\n      - irrigation-network\n    restart: unless-stopped\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready -U irrigation_user"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\n  # Main Application (MQTT Consumer + Analyzer)\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile\n    container_name: irrigation-app\n    environment:\n      - MQTT_BROKER=mosquitto\n      - MQTT_PORT=1883\n      - DATABASE_URL=postgresql://irrigation_user:irrigation_pass@postgres:5432/irrigation_db\n      - PYTHONUNBUFFERED=1\n    volumes:\n      - ./config:/app/config\n      - ./data:/app/data\n      - ./src:/app/src\n      - app-data:/app/storage\n    depends_on:\n      postgres:\n        condition: service_healthy\n      mosquitto:\n        condition: service_started\n    networks:\n      - irrigation-network\n    restart: unless-stopped\n    command: python main.py\n\n  # Mock IoT Sensor Simulator\n  sensor-simulator:\n    build:\n      context: .\n      dockerfile: Dockerfile\n    container_name: irrigation-sensors\n    environment:\n      - MQTT_BROKER=mosquitto\n      - MQTT_PORT=1883\n      - SENSOR_INTERVAL=10\n    volumes:\n      - ./data:/app/data\n      - ./config:/app/config\n    depends_on:\n      - mosquitto\n    networks:\n      - irrigation-network\n    restart: unless-stopped\n    command: python data/mock_data_generator.py\n\n  # Streamlit Dashboard\n  dashboard:\n    build:\n      context: .\n      dockerfile: Dockerfile\n    container_name: irrigation-dashboard\n    environment:\n      - DATABASE_URL=postgresql://irrigation_user:irrigation_pass@postgres:5432/irrigation_db\n      - MQTT_BROKER=mosquitto\n      - MQTT_PORT=1883\n    ports:\n      - "8501:8501"\n    volumes:\n      - ./app:/app/app\n      - ./src:/app/src\n      - ./config:/app/config\n    depends_on:\n      - postgres\n      - mosquitto\n    networks:\n      - irrigation-network\n    restart: unless-stopped\n    command: streamlit run app/dashboard.py --server.port=8501 --server.address=0.0.0.0\n\nnets:\n  irrigation-network:\n    driver: bridge\n\nvolumes:\n  postgres-data:\n  app-data: